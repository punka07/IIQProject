<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow explicitTransitions="true" libraries="Identity" name="COB-Workflow-AD-Create-Employee" type="Subprocess">
  <Variable input="true" name="project" output="true">
    <Description>Project that will be provisioned.</Description>
  </Variable>
  <Variable input="true" name="identityName"/>
  <Variable input="true" name="source"/>
  <Variable input="true" name="launcher"/>
  <Variable name="plan">
    <Description>The provisioning plan which is built during the workflow</Description>
  </Variable>
  <Variable input="true" name="email"/>
  <Variable input="true" name="defaultPassword"/>
  <Variable input="true" name="isBPSEmployee"/>
  <Variable name="result"/>
  <Variable name="LCMEvent"/>
  <Variable initializer=",ou=Room 708,ou=DoIT,ou=CoB,dc=IAM-AD-Dev,dc=cob" name="baseDN"/>
  <Variable name="bpsBaseDN"/>
  <RuleLibraries>
    <Reference class="sailpoint.object.Rule" name="COB-Rule-SpAcctProvisioningRuleLibrary"/>
    <Reference class="sailpoint.object.Rule" name="cobUtils"/>
    <Reference class="sailpoint.object.Rule" name="COB-Rule-AuditRuleLibrary"/>
    <Reference class="sailpoint.object.Rule" name="COB-Rule-ProvisioningRuleLibrary"/>
    <Reference class="sailpoint.object.Rule" name="Approval Library"/>
    <Reference class="sailpoint.object.Rule" name="LCM Workflow Library"/>
  </RuleLibraries>
  <Step icon="Start" name="Start" posX="17" posY="104" resultVariable="workflowLogPrefix">
    <Script>
      <Source><![CDATA[
      	String workflowLogPrefix = workflow.getName() + "::" + identityName + "::"; 
		return workflowLogPrefix;
	  ]]></Source>
    </Script>
    <Transition to="AD_Provision_Plan"/>
  </Step>
  <Step icon="Message" name="AD_Provision_Plan" posX="117" posY="104" resultVariable="plan">
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="plan" value="ref:plan"/>
    <Arg name="baseDN" value="ref:baseDN"/>
    <Arg name="bpsBaseDN" value="ref:bpsBaseDN"/>
    <Arg name="email" value="ref:email"/>
    <Arg name="defaultPassword" value="ref:defaultPassword"/>
    <Arg name="isBPSEmployee" value="ref:isBPSEmployee"/>
    <Script>
      <Source><![CDATA[
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import sailpoint.api.SailPointContext;
import sailpoint.object.Identity;
import sailpoint.object.ManagedAttribute;
import sailpoint.object.ProvisioningPlan;
import sailpoint.object.ProvisioningPlan.AccountRequest;
import sailpoint.object.ProvisioningPlan.AttributeRequest;
import sailpoint.workflow.WorkflowContext;

		String logPrefix = workflowLogPrefix + wfcontext.getStep().getName() + "::";
		cobLog(logPrefix, "EnterStep");
	
	     /**
         *
         * Get attributes and values from the identity created with PeopleSoft HCM link
         * Create a provisioning plan
         */

        Identity ident = context.getObjectByName(Identity.class,identityName);
        String hostName=getADHost("Dev_CityHall_AD", context);
        String bpsHostName=getADHost("Dev_BPS_AD", context);
        String firstName= ident.getFirstname();
        String lastName =ident.getLastname();
        String displayName=ident.getDisplayName();
        String password =getPasswordFor_S_Account(); 
       
        
       
       
       
        String sAMAccountName = ident.getStringAttribute("employeeId");
         String uniqueOU= sAMAccountName.substring(0,3);
        ProvisioningPlan ADplan = new ProvisioningPlan();


        // create AD account

        ProvisioningPlan.AccountRequest acctReqAD = new  ProvisioningPlan.AccountRequest();
        acctReqAD.setOperation(ProvisioningPlan.AccountRequest.Operation.Create);
        if(isBPSEmployee) {
            acctReqAD.setApplication("Dev_BPS_AD");
            acctReqAD.setNativeIdentity("cn=" + ident.getName() + baseDN);
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("accountFlags","Normal User Account"));
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("distinguishedName", "cn=" + ident.getName() +uniqueOU+ bpsBaseDN));
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("userPrincipalName", sAMAccountName + bpsHostName));
            /**Add default group memberships here -- add "memberOf"**/
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("memberOf",ProvisioningPlan.Operation.Add,""));
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("memberOf",ProvisioningPlan.Operation.Add,""));
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("memberOf",ProvisioningPlan.Operation.Add,""));
        }else{

            acctReqAD.setApplication("Dev_CityHall_AD");
            acctReqAD.setNativeIdentity("cn=" + ident.getName() + baseDN);
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("distinguishedName", "cn=" + ident.getName() + baseDN));
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("userPrincipalName", sAMAccountName + hostName));
            /**Add default group memberships here -- add "memberOf"**/
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("memberOf",ProvisioningPlan.Operation.Add,""));
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("memberOf",ProvisioningPlan.Operation.Add,""));
            acctReqAD.add(new ProvisioningPlan.AttributeRequest("memberOf",ProvisioningPlan.Operation.Add,""));
        }
        acctReqAD.add(new ProvisioningPlan.AttributeRequest("password",context.encrypt(password)));
        acctReqAD.add(new ProvisioningPlan.AttributeRequest("sAMAccountName",sAMAccountName));
        acctReqAD.add(new ProvisioningPlan.AttributeRequest("ObjectType","User" ));
        acctReqAD.add(new ProvisioningPlan.AttributeRequest("pwdLastSet","false" ));
        acctReqAD.add(new ProvisioningPlan.AttributeRequest("givenName",firstName));
        acctReqAD.add(new ProvisioningPlan.AttributeRequest("sn",lastName));
        acctReqAD.add(new ProvisioningPlan.AttributeRequest("displayName",displayName));
        

		List lAccreqs = new ArrayList();
		lAccreqs.add(acctReqAD);

		ADplan.setAccountRequests(lAccreqs);
		ADplan.setIdentity(ident);
		return ADplan;
		]]></Source>
    </Script>
    <Transition to="Provision_Project"/>
  </Step>
  <Step action="compileProvisioningProject" icon="Default" name="Provision_Project" posX="267" posY="104" resultVariable="project">
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="plan" value="ref:plan"/>
    <Arg name="project" value="ref:project"/>
    <Arg name="noApplicationTemplates" value="true"/>
    <Arg name="requireCreateTemplates" value="false"/>
    <Arg name="optimisticProvisioning" value="false"/>
    <Arg name="source" value="UI"/>
    <Arg name="requester" value="spadmin"/>
    <Arg name="noLocking" value="true"/>
    <Transition to="Provision"/>
  </Step>
  <Step action="call:provisionProject" icon="Provision" name="Provision" posX="258" posY="100">
    <Arg name="project" value="ref:project"/>
    <Arg name="background" value="false"/>
    <Transition to="ProvisioningResults"/>
  </Step>
  <Step icon="Default" name="ProvisioningResults" posX="557" posY="24">
    <Script>
      <Source><![CDATA[
import sailpoint.tools.Util;
		String logPrefix = workflowLogPrefix + wfcontext.getStep().getName() + "::";
		cobLog(logPrefix, "EnterStep");
		cobLog(logPrefix, "wfcontext.getStep().getName()=" + wfcontext.getStep().getName());
		if (!Util.isEmpty(wfcontext.getRootWorkflowCase().getMessages())) {
			for (Object msgObj : wfcontext.getRootWorkflowCase().getMessages()) {
				sailpoint.tools.Message msg = (sailpoint.tools.Message) msgObj;
				log.warn(logPrefix+msg.getMessage());
			}
		} 
   	]]></Source>
    </Script>
    <Transition to="Audit_Create"/>
  </Step>
  <Step icon="Audit" name="Audit_Create" posX="567" posY="104">
    <Arg name="source" value="ref:source"/>
    <Arg name="launcher" value="ref:launcher"/>
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="project" value="ref:project"/>
    <Script>
      <Source><![CDATA[
		String logPrefix = workflowLogPrefix + wfcontext.getStep().getName() + "::";
		cobLog(logPrefix, "EnterStep");
		Identity idn = context.getObject(Identity.class, identityName);
		cobProvisioningAuditLog(logPrefix, source, launcher, project, idn);
		cobLog(logPrefix, "Exit Step");
	]]></Source>
    </Script>
    <Transition to="Send Notifications"/>
  </Step>
  <Step name="Send Notifications" posX="1130" posY="107">
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="email" value="ref:email"/>
    <Arg name="defaultPassword" value="ref:defaultPassword"/>
    <Arg name="isBPSEmployee" value="ref:isBPSEmployee"/>
    <Script>
      <Source><![CDATA[
	  	import java.util.*;
		import sailpoint.object.EmailTemplate;
		import sailpoint.object.EmailOptions;
		import java.util.Map;
		import java.util.HashMap;
		import java.text.DateFormat;
		import java.text.SimpleDateFormat;		
		import sailpoint.object.*;
		import sailpoint.server.Auditor;

		String logPrefix = workflow.getName() + "::" + identityName + "::" + wfcontext.getStep().getName() + "::";

		Identity user = context.getObject(Identity.class, identityName);

		List emails = new ArrayList();
		 Identity manager=user.getManager();
		if (manager != null) {
			String managerEmail = (String) manager.getAttribute("email");
        if(managerEmail != null){
			emails.add(managerEmail);
		}
}
		emails.add(email);
        
		Map variables = new HashMap();
  
		variables.put("firstName", user.getFirstname());
		variables.put("lastName", user.getLastname());
		if(isBPSEmployee){
        variables.put("userName", "selbmum" + "\\" + identityName);
        }else{
		variables.put("userName", "IAM-AD-DEV" + "\\" + identityName);
        }
		variables.put("email", email);
		variables.put("userPassword", defaultPassword);
	

		boolean sendEmail = false;
		if (Util.size(user.getLinks()) > 1) {
			sendEmail = true;
		}

		if (sendEmail) {
			String accountInfoTemplate = "COB-EmailTemplate-EmployeeAcctInfo";
			String passwordInfoTemplate = "COB-EmailTemplate-EmployeeAcct-ADPassword";
        
      EmailTemplate infoEmailTemplate = context.getObjectByName(EmailTemplate.class,accountInfoTemplate);
      EmailTemplate pswdEmailTemplate = context.getObjectByName(EmailTemplate.class,passwordInfoTemplate);

        
		  EmailOptions emailOptions= new EmailOptions();
      emailOptions.setVariables(variables);
      emailOptions.setTo(emails);
      emailOptions.setSendImmediate(true);
        
      context.sendEmailNotification(infoEmailTemplate, emailOptions);
      context.sendEmailNotification(pswdEmailTemplate, emailOptions);
		}
		
			log.warn("Email Sent");
	  ]]></Source>
    </Script>
    <Transition to="End"/>
  </Step>
  <Step icon="Stop" name="End" posX="717" posY="104"/>
  <Step catches="complete" icon="Catches" name="HandleException" posX="37" posY="690">
    <Script>
      <Source><![CDATA[
      
		   String logPrefix = workflowLogPrefix + wfcontext.getStep().getName() + "::";
		   try {
	            cobLog(logPrefix, "EnterStep");
				if(!wfcontext.getWorkflowCase().getErrors().isEmpty()){
				sendErrorEmailFromWorkflow(wfcontext);
				}
				cobLog(logPrefix, "ExitStep");
			}
		 catch (Throwable e) {
			cobLog(logPrefix, "Exception:");
			e.printStackTrace();
		}
	  
      ]]></Source>
    </Script>
  </Step>
</Workflow>
